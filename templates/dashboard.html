<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel de verificaci√≥n</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <style>
    body { background: #f7f8fb; }
    .card { border-radius: 16px; box-shadow: 0 6px 18px rgba(0,0,0,.05); }
    .json-stringify { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: .9rem; }
    .json-key { color: #1d4ed8; }
    .json-string { color: #059669; }
    .json-number { color: #b45309; }
    .json-boolean { color: #dc2626; }
    .json-null { color: #6b7280; }
    .thumb { width: 56px; height: 56px; object-fit: cover; border-radius: 8px; }
    .sticky { position: sticky; top: 1rem; }
  </style>
</head>
<body>
<div class="container-fluid py-4">
  <h1 class="mb-4 text-center">Panel de verificaci√≥n</h1>
  <div class="row g-3">
    <div class="col-12 col-lg-3">
      <div class="card sticky">
        <div class="card-header">Cargar imagen</div>
        <div class="card-body">
          <form id="uploadForm" enctype="multipart/form-data">
            <input class="form-control mb-3" type="file" id="imageFile" name="imageFile" accept="image/*" required>
            <select id="validClass" class="form-select mb-2">
              <option value="ripen" selected>ripen</option>
              <option value="unripen">unripen</option>
              <option value="mango">mango</option>
              <option value="pineapple">pineapple</option>
            </select>
            <input type="range" class="form-range" min="0" max="1" step="0.01" value="0.5" id="threshold">
            <div class="text-center py-2">
              <img id="imagePreview" src="#" alt="Vista previa" style="display:none; max-width:100%;"/>
              <p id="noPreviewText" class="text-muted">A√∫n no hay imagen seleccionada.</p>
            </div>
            <div class="d-grid">
              <button type="submit" class="btn btn-primary">Procesar</button>
            </div>
          </form>
        </div>
      </div>
      <div class="card mt-3 sticky">
        <div class="card-header">Historial reciente</div>
        <div class="card-body">
          <ul id="history" class="list-unstyled mb-0 small"></ul>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-5">
      <div class="card h-100">
        <div class="card-header">An√°lisis</div>
        <div class="card-body text-center">
          <div class="alert alert-success">V√°lidos: <strong id="qtyValidText">0</strong></div>
          <div class="alert alert-danger">Inv√°lidos: <strong id="qtyInvalidText">0</strong></div>
          <img id="imageProcessed" src="#" alt="Procesada" class="img-fluid rounded" style="display:none;">
          <a id="btnDownload" class="btn btn-outline-primary mt-2" download="procesado.png">Descargar</a>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-4">
      <div class="card h-100">
        <div class="card-header">Acciones</div>
        <div class="card-body">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="alertSwitch">
            <label class="form-check-label" for="alertSwitch">Alertar si inv√°lidos &gt; 0</label>
          </div>
          <div class="mt-3" id="lastMsg">Listo para procesar.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- GRAFICO FUERA DEL CUADRO PRINCIPAL -->
  <div class="row mt-5">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Gr√°fico de Predicciones desde InstantDB</span>
          <small class="text-muted" id="statusGrafico">üìä Cargando datos...</small>
        </div>
        <div class="card-body">
          <canvas id="barChart" height="100"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- LIBRERIAS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://unpkg.com/@instantdb/core@latest/dist/standalone/index.umd.cjs"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const { init, id } = window.instant;
  let globalDB = null;
  let lastImageDataUrl = null;

  async function initDB() {
    globalDB = await init({ appId: '646b5cf0-25ff-4084-9ed9-505666a1bb1a' });
    renderChart();
  }

  function showToast(msg, ok=true){ console.log(msg); }
  function updateCounts(json) {
    const validClass = document.getElementById('validClass').value;
    const threshold = parseFloat(document.getElementById('threshold').value);
    let valid = 0, invalid = 0;
    if (json && Array.isArray(json.predictions)) {
      for (const p of json.predictions) {
        const cls = p.class ?? p.label ?? p.name;
        const conf = p.confidence ?? p.score ?? 0;
        if (cls === validClass && conf >= threshold) valid++; else invalid++;
      }
    }
    document.getElementById('qtyValidText').textContent = valid;
    document.getElementById('qtyInvalidText').textContent = invalid;
    if (document.getElementById('alertSwitch').checked && invalid > 0) {
      alert(`‚ö†Ô∏è Se detectaron ${invalid} inv√°lidos`);
    }
  }

  async function renderChart() {
    if (!globalDB) return;
    const registros = await globalDB.query(globalDB.q.predictions.all());
    document.getElementById('statusGrafico').textContent = `‚úÖ ${registros.length} registros cargados`;
    const clases = {};
    registros.forEach(r => {
      const c = r.claseValidada || 'otro';
      if (!clases[c]) clases[c] = { validos: 0, invalidos: 0 };
      clases[c].validos += r.validos;
      clases[c].invalidos += r.invalidos;
    });
    const labels = Object.keys(clases);
    const validos = labels.map(c => clases[c].validos);
    const invalidos = labels.map(c => clases[c].invalidos);
    const ctx = document.getElementById('barChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'V√°lidos', data: validos, backgroundColor: 'rgba(34,197,94,0.8)' },
          { label: 'Inv√°lidos', data: invalidos, backgroundColor: 'rgba(239,68,68,0.8)' }
        ]
      },
      options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: 'Conteo por clase' } } }
    });
  }

  $(document).ready(function () {
    initDB();
    $('#imageFile').change(function () {
      const file = this.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          $('#imagePreview').attr('src', e.target.result).show();
          $('#noPreviewText').hide();
        };
        reader.readAsDataURL(file);
      }
    });

    $('#uploadForm').submit(function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      $.ajax({
        url: '/process',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
          const dataUrl = 'data:image/png;base64,' + response.image;
          $('#imageProcessed').attr('src', dataUrl).show();
          $('#btnDownload').attr('href', dataUrl);
          lastImageDataUrl = dataUrl;
          updateCounts(response.json);
          $('#lastMsg').text('‚úî Procesado con √©xito');
          if (globalDB) {
            globalDB.transact(globalDB.tx.predictions[id()].create({
              fecha: new Date().toISOString(),
              claseValidada: document.getElementById('validClass').value,
              umbral: parseFloat(document.getElementById('threshold').value),
              validos: parseInt(document.getElementById('qtyValidText').textContent),
              invalidos: parseInt(document.getElementById('qtyInvalidText').textContent),
              imagen: lastImageDataUrl,
              predicciones: response.json.predictions
            })).then(() => renderChart());
          }
        },
        error: function () {
          $('#lastMsg').text('‚ùå Error al procesar.');
        }
      });
    });
  });
</script>
</body>
</html>
