<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de verificaci칩n</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://unpkg.com/@instantdb/core@latest/dist/standalone/index.umd.js"></script>
</head>

<body class="bg-light">
  <div class="container py-4">
    <h1 class="text-center mb-4">Panel de verificaci칩n</h1>

    <!-- Gr치fico de torta -->
    <div class="card mb-4">
      <div class="card-header">Gr치fico acumulado (torta)</div>
      <div class="card-body">
        <div id="pieChart" style="height: 350px;"></div>
      </div>
    </div>

    <!-- Gr치fico de barras -->
    <div class="card">
      <div class="card-header">Historial completo de an치lisis (barras)</div>
      <div class="card-body">
        <div id="barChart" style="height: 400px;"></div>
      </div>
    </div>
  </div>

  <script>
    const { init, id } = window.instant;

    // 游눠 Define el esquema tal cual tu base
    const schema = {
      predictions: {
        id: 'string',
        claseValidada: 'string',
        fecha: 'string',
        imagen: 'string',
        invalidos: 'number',
        predicciones: 'json',
        umbral: 'number',
        validos: 'number'
      }
    };

    async function cargarGraficos() {
      const db = await init({ appId: '646b5cf0-25ff-4084-9ed9-505666a1bb1a', schema });
      const resultados = await db.query(db.q.predictions.all());

      if (!resultados || resultados.length === 0) {
        document.getElementById('pieChart').innerHTML = '<p class="text-muted">Sin datos para mostrar.</p>';
        document.getElementById('barChart').innerHTML = '<p class="text-muted">Sin datos para mostrar.</p>';
        return;
      }

      // Torta acumulada
      const totalValidos = resultados.reduce((s, r) => s + (r.validos || 0), 0);
      const totalInvalidos = resultados.reduce((s, r) => s + (r.invalidos || 0), 0);

      Plotly.newPlot('pieChart', [{
        values: [totalValidos, totalInvalidos],
        labels: ['V치lidos', 'Inv치lidos'],
        type: 'pie',
        marker: { colors: ['#22c55e', '#ef4444'] }
      }], {
        title: 'Distribuci칩n total de an치lisis',
        margin: { t: 40, b: 30 }
      });

      // Barras por fecha
      const fechas = resultados.map(r => new Date(r.fecha).toLocaleString());
      const validos = resultados.map(r => r.validos || 0);
      const invalidos = resultados.map(r => r.invalidos || 0);

      Plotly.newPlot('barChart', [
        {
          x: fechas,
          y: validos,
          name: 'V치lidos',
          type: 'bar',
          marker: { color: '#22c55e' }
        },
        {
          x: fechas,
          y: invalidos,
          name: 'Inv치lidos',
          type: 'bar',
          marker: { color: '#ef4444' }
        }
      ], {
        barmode: 'group',
        title: 'Historial de an치lisis',
        xaxis: { title: 'Fecha de an치lisis' },
        yaxis: { title: 'Cantidad' }
      });
    }

    window.addEventListener('DOMContentLoaded', cargarGraficos);
  </script>
</body>

</html>
